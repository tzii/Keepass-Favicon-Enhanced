name: Build PLGX

on:
  push:
    branches: [ master, main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ master, main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    - name: Download KeePass
      run: |
        & curl.exe -L -o KeePass.zip "https://sourceforge.net/projects/keepass/files/KeePass%202.x/2.54/KeePass-2.54.zip/download"
        Expand-Archive -Path "KeePass.zip" -DestinationPath "KeePass"

    - name: Build PLGX
      shell: cmd
      run: |
        set KEEPASS=%CD%\KeePass\KeePass.exe
        plgx-build.bat no-pause

    - name: Upload PLGX
      uses: actions/upload-artifact@v4
      with:
        name: KeePassIconFetch
        path: KeePassIconFetch.plgx

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v2
      with:
        files: KeePassIconFetch.plgx
        generate_release_notes: true
